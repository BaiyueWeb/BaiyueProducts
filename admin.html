<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản trị sản phẩm</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        textarea { resize: vertical; }
        .error { color: red; }
    </style>
</head>
<body class="bg-gray-100 p-6">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-2xl font-bold mb-4">Quản trị sản phẩm</h1>
        
        <!-- Form đăng nhập -->
        <div id="login-section" class="mb-6">
            <input type="password" id="password" class="border p-2 mr-2" placeholder="Nhập mật khẩu">
            <button onclick="login()" class="bg-blue-500 text-white p-2 rounded">Đăng nhập</button>
        </div>

        <!-- Form nhập thông tin GitHub -->
        <div id="github-config" class="mb-6 hidden">
            <input type="text" id="repo" class="border p-2 mb-2 w-full" placeholder="Repository (VD: username/repo)">
            <input type="password" id="github-token" class="border p-2 mb-2 w-full" placeholder="GitHub Personal Access Token">
            <button onclick="saveConfig()" class="bg-blue-500 text-white p-2 rounded">Lưu cấu hình</button>
            <p id="config-error" class="error hidden"></p>
        </div>

        <!-- Danh sách sản phẩm -->
        <div id="admin-section" class="hidden">
            <h2 class="text-xl font-semibold mb-2">Danh sách sản phẩm</h2>
            <div id="product-list" class="space-y-4"></div>

            <!-- Form thêm sản phẩm -->
            <h2 class="text-xl font-semibold mt-6 mb-2">Thêm sản phẩm mới</h2>
            <div class="bg-white p-4 rounded shadow">
                <input type="text" id="product-name" class="border p-2 mb-2 w-full" placeholder="Tên sản phẩm">
                <textarea id="product-keywords" class="border p-2 mb-2 w-full" placeholder="Từ khóa (cách nhau bằng dấu phẩy)"></textarea>
                <textarea id="product-description" class="border p-2 mb-2 w-full" placeholder="Mô tả sản phẩm"></textarea>
                <input type="text" id="product-picture" class="border p-2 mb-2 w-full" placeholder="Đường dẫn ảnh (VD: ./img/product/ten-anh.jpg)">
                <input type="text" id="product-group" class="border p-2 mb-2 w-full" placeholder="Nhóm sản phẩm" value="Rubber & Plastics">
                <input type="text" id="place-origin" class="border p-2 mb-2 w-full" placeholder="Nơi xuất xứ" value="Vietnam">
                <input type="text" id="brand-name" class="border p-2 mb-2 w-full" placeholder="Thương hiệu" value="Dong Nai">
                <input type="text" id="model-number" class="border p-2 mb-2 w-full" placeholder="Mã model">
                <input type="text" id="fob-currency" class="border p-2 mb-2 w-full" placeholder="Tiền tệ FOB" value="USD">
                <input type="text" id="unit" class="border p-2 mb-2 w-full" placeholder="Đơn vị" value="tons">
                <input type="text" id="fob" class="border p-2 mb-2 w-full" placeholder="Giá FOB" value="$1200-1300">
                <input type="text" id="moq" class="border p-2 mb-2 w-full" placeholder="Số lượng tối thiểu (MOQ)" value="20 tons">
                <input type="text" id="payment-type" class="border p-2 mb-2 w-full" placeholder="Phương thức thanh toán" value="LC, Money gram">
                <input type="text" id="shipping" class="border p-2 mb-2 w-full" placeholder="Thông tin vận chuyển" value="Shipping fee and delivery date to be negotiated. Chat with supplier now for more details.">
                <input type="text" id="shipping-port" class="border p-2 mb-2 w-full" placeholder="Cảng vận chuyển" value="Cat Lai port">
                <input type="text" id="quantities" class="border p-2 mb-2 w-full" placeholder="Số lượng/tháng" value="100 tons/month">
                <input type="text" id="packing-detail" class="border p-2 mb-2 w-full" placeholder="Chi tiết đóng gói" value="33.33kilos each: each export container 20’ may contain from 20 ton (600 bales) to 21 ton (630 bales).">
                <button onclick="addProduct()" class="bg-green-500 text-white p-2 rounded">Thêm sản phẩm</button>
                <p id="error" class="error hidden"></p>
            </div>
        </div>
    </div>

    <script>
        const correctPassword = "admin123"; // Thay đổi mật khẩu nếu cần
        let products = [];
        let githubToken = "";
        let repo = "";

        function login() {
            const password = document.getElementById("password").value;
            if (password === correctPassword) {
                document.getElementById("login-section").classList.add("hidden");
                document.getElementById("github-config").classList.remove("hidden");
            } else {
                alert("Mật khẩu sai!");
            }
        }

        function saveConfig() {
            const configError = document.getElementById("config-error");
            configError.classList.add("hidden");

            githubToken = document.getElementById("github-token").value;
            repo = document.getElementById("repo").value;

            if (!githubToken || !repo) {
                configError.textContent = "Vui lòng nhập PAT và repository!";
                configError.classList.remove("hidden");
                return;
            }

            document.getElementById("github-config").classList.add("hidden");
            document.getElementById("admin-section").classList.remove("hidden");
            loadProducts();
        }

        async function loadProducts() {
            try {
                const response = await fetch("data.json");
                products = await response.json();
                displayProducts();
            } catch (error) {
                console.error("Lỗi khi tải sản phẩm:", error);
                alert("Không thể tải dữ liệu sản phẩm!");
            }
        }

        function displayProducts() {
            const productList = document.getElementById("product-list");
            productList.innerHTML = "";
            products.forEach(product => {
                const div = document.createElement("div");
                div.className = "bg-white p-4 rounded shadow flex justify-between items-center";
                div.innerHTML = `
                    <div>
                        <h3 class="font-bold">${product["Product name"]}</h3>
                        <p>${product["specification"]["Model number"]}</p>
                    </div>
                    <button onclick="deleteProduct(${product.id})" class="bg-red-500 text-white p-2 rounded">Xóa</button>
                `;
                productList.appendChild(div);
            });
        }

        function addProduct() {
            const error = document.getElementById("error");
            error.classList.add("hidden");

            const newProduct = {
                id: products.length ? Math.max(...products.map(p => p.id)) + 1 : 1,
                "Product name": document.getElementById("product-name").value,
                "Product Keyword": document.getElementById("product-keywords").value || null,
                "Product Description": document.getElementById("product-description").value,
                "Product Pictures": [document.getElementById("product-picture").value],
                specification: {
                    "Product group": document.getElementById("product-group").value,
                    "Place of origin": document.getElementById("place-origin").value,
                    "Brand name": document.getElementById("brand-name").value,
                    "Model number": document.getElementById("model-number").value,
                    "FOB Currency": document.getElementById("fob-currency").value,
                    Unit: document.getElementById("unit").value,
                    FOB: document.getElementById("fob").value,
                    MOQ: document.getElementById("moq").value,
                    "Accepted payment type": document.getElementById("payment-type").value,
                    Shipping: document.getElementById("shipping").value,
                    "Shipping Port": document.getElementById("shipping-port").value,
                    "Quantities & units": document.getElementById("quantities").value,
                    "Packing Detail": document.getElementById("packing-detail").value
                }
            };

            if (!newProduct["Product name"] || !newProduct["Product Description"] || !newProduct.specification["Model number"]) {
                error.textContent = "Vui lòng nhập tên, mô tả và mã model sản phẩm!";
                error.classList.remove("hidden");
                return;
            }

            products.push(newProduct);
            displayProducts();
            saveProducts();
            clearForm();
        }

        function deleteProduct(id) {
            products = products.filter(p => p.id !== id);
            displayProducts();
            saveProducts();
        }

        function clearForm() {
            document.querySelectorAll("input, textarea").forEach(input => {
                if (!input.value.startsWith("Rubber & Plastics") && 
                    !input.value.startsWith("Vietnam") && 
                    !input.value.startsWith("Dong Nai") && 
                    !input.value.startsWith("USD") && 
                    !input.value.startsWith("tons") && 
                    !input.value.startsWith("$1200-1300") && 
                    !input.value.startsWith("20 tons") && 
                    !input.value.startsWith("LC, Money gram") && 
                    !input.value.startsWith("Shipping fee") && 
                    !input.value.startsWith("Cat Lai port") && 
                    !input.value.startsWith("100 tons/month") && 
                    !input.value.startsWith("33.33kilos")) {
                    input.value = "";
                }
            });
        }

        async function getFileSha() {
            try {
                const response = await fetch(`https://api.github.com/repos/${repo}/contents/data.json`, {
                    headers: {
                        Authorization: `token ${githubToken}`,
                        Accept: "application/vnd.github.v3+json"
                    }
                });
                if (!response.ok) {
                    throw new Error(`Lỗi HTTP: ${response.status}`);
                }
                const data = await response.json();
                return data.sha;
            } catch (error) {
                console.error("Lỗi khi lấy SHA:", error);
                alert(`Không thể lấy SHA của file: ${error.message}`);
                return null;
            }
        }

        async function saveProducts() {
            if (!githubToken || !repo) {
                alert("Vui lòng nhập PAT và repository trong phần cấu hình!");
                document.getElementById("admin-section").classList.add("hidden");
                document.getElementById("github-config").classList.remove("hidden");
                return;
            }

            try {
                const content = JSON.stringify(products, null, 2);
                const sha = await getFileSha();
                if (!sha) return;

                const response = await fetch(`https://api.github.com/repos/${repo}/contents/data.json`, {
                    method: "PUT",
                    headers: {
                        Authorization: `token ${githubToken}`,
                        Accept: "application/vnd.github.v3+json",
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        message: "Cập nhật danh sách sản phẩm",
                        content: btoa(unescape(encodeURIComponent(content))),
                        sha: sha
                    })
                });

                if (response.ok) {
                    alert("Đã lưu thay đổi lên GitHub!");
                } else {
                    const errorData = await response.json();
                    alert(`Lỗi khi lưu: ${errorData.message}`);
                }
            } catch (error) {
                console.error("Lỗi khi lưu sản phẩm:", error);
                alert("Không thể lưu thay đổi lên GitHub!");
            }
        }
    </script>
</body>
</html>